# TP6 : Des bo services dans des bo LANs

# 0. Prérequis

# I. Le setup

## 0. Schéma

☀️ **Prouvez que...**

- une machine du LAN1 peut joindre internet (ping un nom de domaine)

```
[johann@dhcp ~]$ ping www.google.com
PING www.google.com (142.251.37.228) 56(84) bytes of data.
64 bytes from mrs09s16-in-f4.1e100.net (142.251.37.228): icmp_seq=1 ttl=112 time=18.0 ms
64 bytes from mrs09s16-in-f4.1e100.net (142.251.37.228): icmp_seq=2 ttl=112 time=21.3 ms
64 bytes from mrs09s16-in-f4.1e100.net (142.251.37.228): icmp_seq=3 ttl=112 time=20.4 ms
64 bytes from mrs09s16-in-f4.1e100.net (142.251.37.228): icmp_seq=4 ttl=112 time=20.3 ms
^C
--- www.google.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3007ms
rtt min/avg/max/mdev = 17.990/19.994/21.324/1.227 ms
```





- une machine du LAN2 peut joindre internet (ping nom de domaine)

```
[johann@web ~]$ ping www.google.com
PING www.google.com (142.251.37.196) 56(84) bytes of data.
64 bytes from mrs09s15-in-f4.1e100.net (142.251.37.196): icmp_seq=1 ttl=112 time=19.5 ms
64 bytes from mrs09s15-in-f4.1e100.net (142.251.37.196): icmp_seq=2 ttl=112 time=18.8 ms
64 bytes from mrs09s15-in-f4.1e100.net (142.251.37.196): icmp_seq=3 ttl=112 time=26.1 ms
64 bytes from mrs09s15-in-f4.1e100.net (142.251.37.196): icmp_seq=4 ttl=112 time=17.8 ms
64 bytes from mrs09s15-in-f4.1e100.net (142.251.37.196): icmp_seq=5 ttl=112 time=18.5 ms
^C
--- www.google.com ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4014ms
rtt min/avg/max/mdev = 17.760/20.121/26.073/3.030 ms
```




- une machine du LAN1 peut joindre une machine du LAN2 (ping une adresse IP)

```
[johann@dhcp ~]$ ping 10.6.2.11
PING 10.6.2.11 (10.6.2.11) 56(84) bytes of data.
64 bytes from 10.6.2.11: icmp_seq=1 ttl=63 time=2.15 ms
64 bytes from 10.6.2.11: icmp_seq=2 ttl=63 time=3.38 ms
64 bytes from 10.6.2.11: icmp_seq=3 ttl=63 time=1.50 ms
64 bytes from 10.6.2.11: icmp_seq=4 ttl=63 time=1.79 ms
^C
--- 10.6.2.11 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3006ms
rtt min/avg/max/mdev = 1.501/2.204/3.376/0.714 ms
```






## II. LAN clients

## 1. Serveur DHCP


## 2. Client

☀️ **Prouvez que...**

- le client a bien récupéré une adresse IP en DHCP

```
[johann@client1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:5f:18:84 brd ff:ff:ff:ff:ff:ff
    inet 10.6.1.37/24 brd 10.6.1.255 scope global dynamic noprefixroute enp0s3
       valid_lft 2591827sec preferred_lft 2591827sec
    inet6 fe80::a00:27ff:fe5f:1884/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```



- vous avez bien `1.1.1.1` en DNS

```
[johann@client1 ~]$ cat /etc/resolv.conf
# Generated by NetworkManager
search tp6
nameserver 1.1.1.1
```



- vous avez bien la bonne passerelle indiquée

```
[johann@client1 ~]$ ip r s
default via 10.6.1.254 dev enp0s3 proto dhcp src 10.6.1.37 metric 100
10.6.1.0/24 dev enp0s3 proto kernel scope link src 10.6.1.37 metric 100
```


- que ça `ping` un nom de domaine public sans problème magueule

```
[johann@client1 ~]$ ping www.ynov.com
PING www.ynov.com (104.26.11.233) 56(84) bytes of data.
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=1 ttl=53 time=21.0 ms
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=2 ttl=53 time=18.7 ms
64 bytes from 104.26.11.233 (104.26.11.233): icmp_seq=3 ttl=53 time=19.7 ms
^C
--- www.ynov.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 18.714/19.798/20.970/0.923 ms
```


# III. LAN serveurzzzz

## 1. Serveur Web

☀️ **Déterminer sur quel port écoute le serveur NGINX**

```
[johann@web ~]$ sudo ss -lnpt | grep 80
LISTEN 0      511          0.0.0.0:80        0.0.0.0:*    users:(("nginx",pid=1634,fd=6),("nginx",pid=1633,fd=6))
LISTEN 0      511             [::]:80           [::]:*    users:(("nginx",pid=1634,fd=7),("nginx",pid=1633,fd=7))
```


☀️ **Ouvrir ce port dans le firewall**

```
[johann@web ~]$ sudo firewall-cmd --permanent --add-port=80/tcp
success
[johann@web ~]$ sudo firewall-cmd --reload
success
```


☀️ **Visitez le site web !**

```
[johann@web ~]$ curl http://10.6.2.11
<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>HTTP Server Test Page powered by: Rocky Linux</title>
    <style type="text/css">
      /*<![CDATA[*/

      html {
        height: 100%;
        width: 100%;
      }
        body {
  background: rgb(20,72,50);
  background: -moz-linear-gradient(180deg, rgba(23,43,70,1) 30%, rgba(0,0,0,1) 90%)  ;
  background: -webkit-linear-gradient(180deg, rgba(23,43,70,1) 30%, rgba(0,0,0,1) 90%) ;
  background: linear-gradient(180deg, rgba(23,43,70,1) 30%, rgba(0,0,0,1) 90%);
  background-repeat: no-repeat;
  background-attachment: fixed;
  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#3c6eb4",endColorstr="#3c95b4",GradientType=1);
        color: white;
        font-size: 0.9em;
        font-weight: 400;
        font-family: 'Montserrat', sans-serif;
        margin: 0;
        padding: 10em 6em 10em 6em;
        box-sizing: border-box;

      }
```



## 2. Serveur DNS

#### 4. Analyse du service

☀️ **Déterminer sur quel(s) port(s) écoute le service BIND9**

```
[johann@dns ~]$ sudo ss -lnpt | grep 53
LISTEN 0      10         127.0.0.1:53        0.0.0.0:*    users:(("named",pid=1550,fd=22))
LISTEN 0      4096       127.0.0.1:953       0.0.0.0:*    users:(("named",pid=1550,fd=28))
LISTEN 0      10         10.6.2.12:53        0.0.0.0:*    users:(("named",pid=1550,fd=25))
LISTEN 0      10             [::1]:53           [::]:*    users:(("named",pid=1550,fd=27))
LISTEN 0      4096           [::1]:953          [::]:*    users:(("named",pid=1550,fd=29))
```




☀️ **Ouvrir ce(s) port(s) dans le firewall**

Commandes :
```
[johann@dns ~]$ sudo firewall-cmd --permanent --add-port=53/tcp
success
[johann@dns ~]$ sudo firewall-cmd --reload
success
```

Preuve qu'il est ouvert :

```
[johann@dns ~]$ sudo firewall-cmd --permanent --add-port=53/tcp
Warning: ALREADY_ENABLED: 53:tcp
success
```



#### 5. Tests manuels

☀️ **Effectuez des requêtes DNS manuellement** 
- cette commande demande à 10.6.2.12 à quelle IP correspond web.tp6.b1

  ```
  [johann@dns ~]$ dig web.tp6.b1 @10.6.2.12
  [...]
  ;; ANSWER SECTION:
  web.tp6.b1.             86400   IN      A       10.6.2.11
  [...]
  ```

- dig dns.tp6.b1 @10.6.2.12

  ```
  [johann@dns ~]$ dig dns.tp6.b1 @10.6.2.12

  [...]
  ;; ANSWER SECTION:
  dns.tp6.b1.             86400   IN      A       10.6.2.12
  [...]
  ```

- dig ynov.com @10.6.2.12

  ```
  [johann@dns ~]$ dig ynov.com @10.6.2.12

  [...]
  ;; ANSWER SECTION:
  ynov.com.               300     IN      A       172.67.74.226
  ynov.com.               300     IN      A       104.26.10.233
  ynov.com.               300     IN      A       104.26.11.233

  [...]
  ```

- demander quel est le nom qui correspond à une IP donnée

  ```
  [johann@dns ~]$ dig -x 10.6.2.11 @10.6.2.12

  [...]

  ;; ANSWER SECTION:
  11.2.6.10.in-addr.arpa. 86400   IN      PTR     web.tp6.b1.
  [...]
  ```

  ```
  [johann@dns ~]$ dig -x 10.6.2.12 @10.6.2.12
  [...]

  ;; ANSWER SECTION:
  12.2.6.10.in-addr.arpa. 86400   IN      PTR     dns.tp6.b1.
  [...]
  ```






☀️ **Effectuez une requête DNS manuellement** 

```
[johann@client1 ~]$ dig web.tp6.b1 @10.6.2.12
[...]
;; ANSWER SECTION:
web.tp6.b1.             86400   IN      A       10.6.2.11
[...]
```





☀️ **Capturez une requête DNS et la réponse de votre serveur**


[DNS](./capture.pcap)



## 3. Serveur DHCP


☀️ **Créez un nouveau client `client2.tp6.b1` vitefé**

- vérifiez que vous avez bien 10.6.2.12 comme serveur DNS à contacter

  ```
  [johann@client2 ~]$ cat /etc/resolv.conf
  # Generated by NetworkManager
  search tp6
  nameserver 10.6.1.12
  ```